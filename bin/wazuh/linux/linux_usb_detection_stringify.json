{
  "file_name": "linux_usb_detection.sh",
  "content": "#!/bin/bash\n\n# Cheching sudo permission\nif [ \"$EUID\" -ne 0 ]; then\n    echo \"Please run this script with sudo privileges.\"\n    exit 1\nfi\n\n# Log file location\nCUSTOM_AR_LOG_FILE=\"/var/ossec/active-response/custom_ar.log\"\n\n###############################################################################################\n### Monitoring USB drives in Linux using Wazuh                                              ###\n### Ref: https://wazuh.com/blog/monitoring-usb-drives-in-linux-using-wazuh/                 ###\n### Ref: oms.brotecs.com/issues/74467                                                       ###\n###############################################################################################\n\n# STEP 1: Create a file named usb_detect.sh in the /var/ossec/bin/ directory:\n[ ! -f \"/var/ossec/bin/usb_detect.sh\" ] && sudo touch \"/var/ossec/bin/usb_detect.sh\"\n\n# STEP 2: Add the following script to the /var/ossec/bin/usb_detect.sh file:\ncat <<'EOF' >/var/ossec/bin/usb_detect.sh\n#!/bin/bash\n\nlog_file=\"/var/log/usb_detect.json\"\nvendor=\"$ID_VENDOR\"\nmodel=\"$ID_MODEL\"\nserial=\"$ID_SERIAL_SHORT\"\ndevice=\"$DEVNAME\"\ndevtype=\"$DEVTYPE\"\nhostname=$(hostname)\n\njson=\"{\\\"hostname\\\":\\\"$hostname\\\",\\\"vendor\\\":\\\"$vendor\\\",\\\"model\\\":\\\"$model\\\",\\\"serial\\\":\\\"$serial\\\",\\\"device\\\":\\\"$device\\\",\\\"type\\\":\\\"$devtype\\\"}\"\n\necho \"$json\" >> \"$log_file\"\nEOF\n\n# STEP 3: Change the file permission to ensure the script cannot be executed by others:\nsudo chmod 700 /var/ossec/bin/usb_detect.sh\n\n# STEP 4: Create a file usb-detect.rules in the /etc/udev/rules.d/ directory:\n[ ! -f \"/etc/udev/rules.d/usb-detect.rules\" ] && sudo touch /etc/udev/rules.d/usb-detect.rules\n\n# STEP 5: Add the following rule to the file:\ncat <<'EOF' >/etc/udev/rules.d/usb-detect.rules\nACTION==\"add\", SUBSYSTEMS==\"usb\", RUN+=\"/var/ossec/bin/usb_detect.sh\"\nEOF\n\n# STEP 6: Run the command below to reload the udev rules:\nsudo udevadm control --reload\n\n# STEP 7: Append the configuration below to the Wazuh agent /var/ossec/etc/ossec.conf file to collect the logs from the /var/log/usb_detect.json file:\n# We will do this in Wazuh Shared agent configuration.\n\n# STEP 8: Restart the Wazuh agent to apply the changes:\nsudo systemctl restart wazuh-agent\n\necho \"Script run successfully.\"\necho \"Script run successfully.\" >>$CUSTOM_AR_LOG_FILE\n"
}